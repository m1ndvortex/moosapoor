const mysql = require('mysql2/promise');

// Database comparison script to identify differences between local and VPS databases

const config = {
    local: {
        host: '127.0.0.1',
        user: 'root', // Change this if needed
        password: '', // Change this to your local password
        database: 'gold_shop_db'
    },
    vps: {
        host: '87.248.131.94',
        user: 'root', // Using root for testing
        password: '18588530', // Your original password
        database: 'gold_shop_db'
    }
};

async function getTableStructure(connection, tableName) {
    try {
        const [columns] = await connection.execute(`DESCRIBE ${tableName}`);
        return columns;
    } catch (error) {
        console.log(`Table ${tableName} does not exist`);
        return null;
    }
}

async function getAllTables(connection) {
    const [tables] = await connection.execute('SHOW TABLES');
    return tables.map(row => Object.values(row)[0]);
}

async function compareDatabase() {
    let localConnection, vpsConnection;
    
    try {
        console.log('üîÑ Connecting to databases...');
        
        // Connect to both databases
        localConnection = await mysql.createConnection(config.local);
        vpsConnection = await mysql.createConnection(config.vps);
        
        console.log('‚úÖ Connected to local database');
        console.log('‚úÖ Connected to VPS database');
        
        // Get all tables from local
        const localTables = await getAllTables(localConnection);
        console.log('\nüìã Local Database Tables:');
        console.log(localTables.sort());
        
        // VPS comparison
        const vpsTables = await getAllTables(vpsConnection);
        console.log('\nüìã VPS Database Tables:');
        console.log(vpsTables.sort());
        
        // Find missing tables
        const missingInVPS = localTables.filter(table => !vpsTables.includes(table));
        const extraInVPS = vpsTables.filter(table => !localTables.includes(table));
        
        if (missingInVPS.length > 0) {
            console.log('\n‚ùå Tables missing in VPS:');
            missingInVPS.forEach(table => console.log(`  - ${table}`));
        }
        
        if (extraInVPS.length > 0) {
            console.log('\n‚ö†Ô∏è  Extra tables in VPS:');
            extraInVPS.forEach(table => console.log(`  - ${table}`));
        }
        
        // Focus on critical tables for purchase invoices
        const criticalTables = ['invoices', 'invoice_items', 'customers', 'inventory_items', 'payments'];
        
        console.log('\nüîç Checking structure of critical tables...');
        
        for (const tableName of criticalTables) {
            console.log(`\nüìä ${tableName.toUpperCase()} TABLE STRUCTURE:`);
            
            const localStructure = await getTableStructure(localConnection, tableName);
            const vpsStructure = await getTableStructure(vpsConnection, tableName);
            
            if (localStructure) {
                console.log('Local columns:');
                localStructure.forEach(col => {
                    console.log(`  ${col.Field} | ${col.Type} | ${col.Null} | ${col.Key} | ${col.Default}`);
                });
            }
            
            if (vpsStructure) {
                console.log('\nVPS columns:');
                vpsStructure.forEach(col => {
                    console.log(`  ${col.Field} | ${col.Type} | ${col.Null} | ${col.Key} | ${col.Default}`);
                });
                
                // Compare structures
                if (localStructure) {
                    const localFields = localStructure.map(col => col.Field);
                    const vpsFields = vpsStructure.map(col => col.Field);
                    
                    const missingInVPS = localFields.filter(field => !vpsFields.includes(field));
                    const extraInVPS = vpsFields.filter(field => !localFields.includes(field));
                    
                    if (missingInVPS.length > 0) {
                        console.log(`\n‚ùå Columns missing in VPS ${tableName}:`);
                        missingInVPS.forEach(field => console.log(`  - ${field}`));
                    }
                    
                    if (extraInVPS.length > 0) {
                        console.log(`\n‚ö†Ô∏è  Extra columns in VPS ${tableName}:`);
                        extraInVPS.forEach(field => console.log(`  - ${field}`));
                    }
                    
                    if (missingInVPS.length === 0 && extraInVPS.length === 0) {
                        console.log(`\n‚úÖ ${tableName} structure matches between local and VPS`);
                    }
                }
            } else {
                console.log(`\n‚ùå Table ${tableName} does not exist on VPS!`);
            }
            
            if (localStructure) {
                
                // Show specific columns that might be missing in VPS
                if (tableName === 'invoices') {
                    const hasPaymentColumns = localStructure.some(col => 
                        ['paid_amount', 'remaining_amount', 'payment_status'].includes(col.Field)
                    );
                    
                    const hasInvoiceType = localStructure.some(col => col.Field === 'invoice_type');
                    
                    console.log(`\nüîç Invoice table analysis:`);
                    console.log(`  - Has payment status columns: ${hasPaymentColumns ? '‚úÖ' : '‚ùå'}`);
                    console.log(`  - Has invoice_type column: ${hasInvoiceType ? '‚úÖ' : '‚ùå'}`);
                    
                    if (!hasPaymentColumns) {
                        console.log(`\n‚ùó Missing payment columns in invoices table!`);
                        console.log(`   Run this SQL on your VPS:`);
                        console.log(`   ALTER TABLE invoices ADD COLUMN paid_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÖÿ®ŸÑÿ∫ Ÿæÿ±ÿØÿßÿÆÿ™ ÿ¥ÿØŸá';`);
                        console.log(`   ALTER TABLE invoices ADD COLUMN remaining_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÖÿ®ŸÑÿ∫ ÿ®ÿßŸÇ€åŸÖÿßŸÜÿØŸá';`);
                        console.log(`   ALTER TABLE invoices ADD COLUMN payment_status ENUM('unpaid','partial','paid') DEFAULT 'unpaid' COMMENT 'Ÿàÿ∂ÿπ€åÿ™ Ÿæÿ±ÿØÿßÿÆÿ™';`);
                    }
                    
                    if (!hasInvoiceType) {
                        console.log(`\n‚ùó Missing invoice_type column!`);
                        console.log(`   Run this SQL on your VPS:`);
                        console.log(`   ALTER TABLE invoices ADD COLUMN invoice_type ENUM('sale','purchase') DEFAULT 'sale' AFTER invoice_date_shamsi;`);
                    }
                }
                
                if (tableName === 'invoice_items') {
                    const hasExtendedColumns = localStructure.some(col => 
                        ['carat', 'manual_weight', 'daily_gold_price', 'tax_amount', 'final_unit_price'].includes(col.Field)
                    );
                    
                    console.log(`\nüîç Invoice_items table analysis:`);
                    console.log(`  - Has extended columns: ${hasExtendedColumns ? '‚úÖ' : '‚ùå'}`);
                    
                    if (!hasExtendedColumns) {
                        console.log(`\n‚ùó Missing extended columns in invoice_items table!`);
                        console.log(`   Run this SQL on your VPS:`);
                        console.log(`   ALTER TABLE invoice_items ADD COLUMN carat INT DEFAULT 18 COMMENT 'ÿπ€åÿßÿ± ÿ∑ŸÑÿß';`);
                        console.log(`   ALTER TABLE invoice_items ADD COLUMN manual_weight DECIMAL(8,3) DEFAULT 0.000 COMMENT 'Ÿàÿ≤ŸÜ ÿØÿ≥ÿ™€å Ÿàÿßÿ±ÿØ ÿ¥ÿØŸá';`);
                        console.log(`   ALTER TABLE invoice_items ADD COLUMN daily_gold_price DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÇ€åŸÖÿ™ ÿ∑ŸÑÿß€å ÿ±Ÿàÿ≤';`);
                        console.log(`   ALTER TABLE invoice_items ADD COLUMN tax_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÖÿ®ŸÑÿ∫ ŸÖÿßŸÑ€åÿßÿ™';`);
                        console.log(`   ALTER TABLE invoice_items ADD COLUMN final_unit_price DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÇ€åŸÖÿ™ ŸÜŸáÿß€å€å Ÿàÿßÿ≠ÿØ';`);
                    }
                }
                
                if (tableName === 'payments') {
                    const hasInvoiceId = localStructure.some(col => col.Field === 'invoice_id');
                    
                    console.log(`\nüîç Payments table analysis:`);
                    console.log(`  - Has invoice_id column: ${hasInvoiceId ? '‚úÖ' : '‚ùå'}`);
                    
                    if (!hasInvoiceId) {
                        console.log(`\n‚ùó Missing invoice_id column in payments table!`);
                        console.log(`   Run this SQL on your VPS:`);
                        console.log(`   ALTER TABLE payments ADD COLUMN invoice_id INT DEFAULT NULL AFTER customer_id;`);
                        console.log(`   ALTER TABLE payments ADD CONSTRAINT payments_ibfk_2 FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE SET NULL;`);
                    }
                }
            } else {
                console.log(`‚ùå Table ${tableName} does not exist locally!`);
            }
            
            console.log('\n' + '='.repeat(80));
        }
        
        // Generate migration script
        console.log('\nüìù SUGGESTED MIGRATION SCRIPT FOR VPS:');
        console.log('='.repeat(50));
        
        const migrationSQL = `
-- Migration script to fix VPS database structure
-- Run these commands on your VPS database

-- 1. Add missing columns to invoices table
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS invoice_type ENUM('sale','purchase') DEFAULT 'sale' AFTER invoice_date_shamsi,
ADD COLUMN IF NOT EXISTS paid_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÖÿ®ŸÑÿ∫ Ÿæÿ±ÿØÿßÿÆÿ™ ÿ¥ÿØŸá' AFTER status,
ADD COLUMN IF NOT EXISTS remaining_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÖÿ®ŸÑÿ∫ ÿ®ÿßŸÇ€åŸÖÿßŸÜÿØŸá' AFTER paid_amount,
ADD COLUMN IF NOT EXISTS payment_status ENUM('unpaid','partial','paid') DEFAULT 'unpaid' COMMENT 'Ÿàÿ∂ÿπ€åÿ™ Ÿæÿ±ÿØÿßÿÆÿ™' AFTER remaining_amount;

-- 2. Add missing columns to invoice_items table  
ALTER TABLE invoice_items
ADD COLUMN IF NOT EXISTS carat INT DEFAULT 18 COMMENT 'ÿπ€åÿßÿ± ÿ∑ŸÑÿß' AFTER description,
ADD COLUMN IF NOT EXISTS manual_weight DECIMAL(8,3) DEFAULT 0.000 COMMENT 'Ÿàÿ≤ŸÜ ÿØÿ≥ÿ™€å Ÿàÿßÿ±ÿØ ÿ¥ÿØŸá' AFTER carat,
ADD COLUMN IF NOT EXISTS daily_gold_price DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÇ€åŸÖÿ™ ÿ∑ŸÑÿß€å ÿ±Ÿàÿ≤' AFTER manual_weight,
ADD COLUMN IF NOT EXISTS tax_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÖÿ®ŸÑÿ∫ ŸÖÿßŸÑ€åÿßÿ™' AFTER daily_gold_price,
ADD COLUMN IF NOT EXISTS final_unit_price DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ŸÇ€åŸÖÿ™ ŸÜŸáÿß€å€å Ÿàÿßÿ≠ÿØ' AFTER tax_amount;

-- 3. Add missing column to payments table
ALTER TABLE payments 
ADD COLUMN IF NOT EXISTS invoice_id INT DEFAULT NULL AFTER customer_id;

-- 4. Add foreign key constraint for payments.invoice_id
ALTER TABLE payments 
ADD CONSTRAINT IF NOT EXISTS payments_ibfk_2 
FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE SET NULL;

-- 5. Ensure inventory_items has category_id column
ALTER TABLE inventory_items 
ADD COLUMN IF NOT EXISTS category_id INT DEFAULT NULL AFTER type_id;

-- 6. Add foreign key for inventory_items.category_id if categories table exists
-- ALTER TABLE inventory_items 
-- ADD CONSTRAINT IF NOT EXISTS inventory_items_ibfk_2 
-- FOREIGN KEY (category_id) REFERENCES categories(id);

-- Verify the changes
SELECT 'invoices table updated' as status;
DESCRIBE invoices;

SELECT 'invoice_items table updated' as status;  
DESCRIBE invoice_items;

SELECT 'payments table updated' as status;
DESCRIBE payments;
`;
        
        console.log(migrationSQL);
        
        // Save migration script to file
        require('fs').writeFileSync('vps-migration.sql', migrationSQL);
        console.log('\nüíæ Migration script saved to vps-migration.sql');
        
    } catch (error) {
        console.error('‚ùå Database comparison error:', error.message);
        
        if (error.code === 'ER_ACCESS_DENIED_ERROR') {
            console.log('\nüîß Database connection failed. Please update the config object at the top of this file with your correct database credentials.');
        }
        
        if (error.code === 'ECONNREFUSED') {
            console.log('\nüîß Cannot connect to database. Make sure your database server is running.');
        }
        
    } finally {
        if (localConnection) await localConnection.end();
        if (vpsConnection) await vpsConnection.end();
    }
}

// Run the comparison
compareDatabase().then(() => {
    console.log('\n‚ú® Database comparison completed!');
    console.log('\nüìã Next steps:');
    console.log('1. Update the config object in this file with your VPS database credentials');
    console.log('2. Uncomment the VPS connection code to compare both databases');
    console.log('3. Run the generated vps-migration.sql script on your VPS database');
    console.log('4. Test the purchase invoice functionality again');
}).catch(console.error);
