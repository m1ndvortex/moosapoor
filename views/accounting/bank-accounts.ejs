<div class="page-header">
    <h1 class="page-title">ูุฏุฑุช ุญุณุงุจโูุง ุจุงูฺฉ</h1>
    <p>ูุฏุฑุช ู ูุธุงุฑุช ุจุฑ ุญุณุงุจโูุง ุจุงูฺฉ ุทูุงูุฑูุด</p>

</div>

<!-- Bank Summary -->
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
    <div class="stat-card">
        <div class="stat-number"><%= bankAccounts.length %></div>
        <div class="stat-label">ุชุนุฏุงุฏ ุญุณุงุจโูุง ุจุงูฺฉ</div>
        <div class="stat-icon" style="color: #17a2b8;">๐ฆ</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number"><%= formatNumber(totalBalance) %></div>
        <div class="stat-label">ูุฌููุน ููุฌูุฏ (ุฑุงู)</div>
        <div class="stat-icon" style="color: #28a745;">๐ฐ</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">
            <%= bankAccounts.reduce((sum, account) => sum + (account.transaction_count || 0), 0) %>
        </div>
        <div class="stat-label">ฺฉู ุชุฑุงฺฉูุดโูุง</div>
        <div class="stat-icon" style="color: #ffc107;">๐</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">
            <%= bankAccounts.reduce((sum, account) => sum + (account.unreconciled_count || 0), 0) %>
        </div>
        <div class="stat-label">ุชุฑุงฺฉูุดโูุง ุชุทุจู ูุดุฏู</div>
        <div class="stat-icon" style="color: #dc3545;">โ๏ธ</div>
    </div>
</div>

<!-- Add New Account Form (Hidden by default) -->
<div class="card" id="addAccountCard" style="display: none;">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ุงูุฒูุฏู ุญุณุงุจ ุจุงูฺฉ ุฌุฏุฏ</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAddAccountForm()">
                <i class="fas fa-times"></i> ุจุณุชู
            </button>
        </div>
    </div>
    <div class="card-body">
        <form method="POST" action="/accounting/bank-accounts/add" id="addAccountForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>ูุงู ุจุงูฺฉ: *</label>
                        <input type="text" name="bank_name" class="form-control" required placeholder="ูุซุงู: ุจุงูฺฉ ูู ุงุฑุงู">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>ุดูุงุฑู ุญุณุงุจ: *</label>
                        <input type="text" name="account_number" class="form-control" required placeholder="0123456789">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>ุตุงุญุจ ุญุณุงุจ: *</label>
                        <input type="text" name="account_holder" class="form-control" required placeholder="ูุงู ุตุงุญุจ ุญุณุงุจ">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>ูุงู ุดุนุจู:</label>
                        <input type="text" name="branch_name" class="form-control" placeholder="ูุงู ุดุนุจู (ุงุฎุชุงุฑ)">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>ููุน ุญุณุงุจ: *</label>
                        <select name="account_type" class="form-control" required>
                            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
                            <option value="checking">ุฌุงุฑ</option>
                            <option value="savings">ูพุณโุงูุฏุงุฒ</option>
                            <option value="business">ุชุฌุงุฑ</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>ููุฌูุฏ ุงููู (ุฑุงู):</label>
                        <input type="number" name="initial_balance" class="form-control" value="0" min="0">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>ุงุฏุฏุงุดุช:</label>
                <textarea name="notes" class="form-control" rows="2" placeholder="ุชูุถุญุงุช ุงุถุงู ุฏุฑ ููุฑุฏ ุงู ุญุณุงุจ"></textarea>
            </div>
            
            <div class="form-group text-center">
                <button type="button" class="btn btn-secondary" onclick="toggleAddAccountForm()">ุงูุตุฑุงู</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> ุฐุฎุฑู ุญุณุงุจ
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bank Accounts Management -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ูุฏุฑุช ุญุณุงุจโูุง</h5>
            <button class="btn btn-success" onclick="toggleAddAccountForm()" id="addAccountBtn">
                <i class="fas fa-plus"></i> ุงูุฒูุฏู ุญุณุงุจ ุจุงูฺฉ ุฌุฏุฏ
            </button>
        </div>
    </div>
    <div class="card-body">
        <% if (bankAccounts.length === 0) { %>
            <div style="text-align: center; padding: 40px; color: #666;">
                <h4>ูฺ ุญุณุงุจ ุจุงูฺฉโุง ุซุจุช ูุดุฏู ุงุณุช</h4>
                <p>ุจุฑุง ุดุฑูุนุ ุงููู ุญุณุงุจ ุจุงูฺฉ ุฎูุฏ ุฑุง ุงุถุงูู ฺฉูุฏ</p>
                <button class="btn btn-primary" onclick="toggleAddAccountForm()">
                    <i class="fas fa-plus"></i> ุงูุฒูุฏู ุญุณุงุจ ุจุงูฺฉ
                </button>
            </div>
        <% } else { %>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead style="background: #f8f9fa;">
                        <tr>
                            <th>ูุงู ุจุงูฺฉ</th>
                            <th>ุดูุงุฑู ุญุณุงุจ</th>
                            <th>ุตุงุญุจ ุญุณุงุจ</th>
                            <th>ููุน ุญุณุงุจ</th>
                            <th>ููุฌูุฏ ุฌุงุฑ</th>
                            <th>ุชุฑุงฺฉูุดโูุง</th>
                            <th>ูุถุนุช</th>
                            <th>ุนููุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% bankAccounts.forEach(account => { %>
                            <tr>
                                <td>
                                    <strong><%= account.bank_name %></strong>
                                    <% if (account.branch_name) { %>
                                        <br>
                                        <small class="text-muted">ุดุนุจู: <%= account.branch_name %></small>
                                    <% } %>
                                </td>
                                <td>
                                    <code><%= account.account_number %></code>
                                </td>
                                <td>
                                    <%= account.account_holder %>
                                </td>
                                <td>
                                    <% if (account.account_type === 'checking') { %>
                                        <span class="badge badge-primary">ุฌุงุฑ</span>
                                    <% } else if (account.account_type === 'savings') { %>
                                        <span class="badge badge-success">ูพุณโุงูุฏุงุฒ</span>
                                    <% } else if (account.account_type === 'business') { %>
                                        <span class="badge badge-info">ุชุฌุงุฑ</span>
                                    <% } else { %>
                                        <span class="badge badge-secondary"><%= account.account_type %></span>
                                    <% } %>
                                </td>
                                <td style="text-align: left; font-weight: bold;">
                                    <% const balance = parseFloat(account.current_balance || 0); %>
                                    <span style="color: <%= balance >= 0 ? '#28a745' : '#dc3545' %>;">
                                        <%= formatNumber(Math.abs(balance)) %> ุฑุงู
                                        <% if (balance < 0) { %>
                                            (ููู)
                                        <% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-info">
                                        <%= account.transaction_count || 0 %> ุชุฑุงฺฉูุด
                                    </span>
                                    <% if (account.unreconciled_count > 0) { %>
                                        <br>
                                        <span class="badge badge-warning">
                                            <%= account.unreconciled_count %> ุชุทุจู ูุดุฏู
                                        </span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (account.is_active) { %>
                                        <span class="badge badge-success">ูุนุงู</span>
                                    <% } else { %>
                                        <span class="badge badge-secondary">ุบุฑูุนุงู</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right">
                                            <h6 class="dropdown-header">
                                                <i class="fas fa-university"></i> <%= account.bank_name %>
                                            </h6>
                                            <a class="dropdown-item" href="/accounting/bank-accounts/<%= account.id %>/transactions">
                                                <i class="fas fa-chart-line text-info"></i> ูุดุงูุฏู ุชุฑุงฺฉูุดโูุง
                                            </a>
                                            <button class="dropdown-item" onclick="addBankTransaction(<%= account.id %>, '<%= account.bank_name %>')">
                                                <i class="fas fa-plus-circle text-success"></i> ุงูุฒูุฏู ุชุฑุงฺฉูุด
                                            </button>
                                            <button class="dropdown-item" onclick="showEditModal(<%= account.id %>)">
                                                <i class="fas fa-edit text-warning"></i> ูุฑุงุด ุญุณุงุจ
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <button class="dropdown-item" onclick="viewAccountDetails(<%= account.id %>)">
                                                <i class="fas fa-eye text-primary"></i> ุฌุฒุฆุงุช ุญุณุงุจ
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <button class="dropdown-item text-danger" onclick="deactivateAccount(<%= account.id %>)">
                                                <i class="fas fa-ban"></i> ุบุฑูุนุงูโุณุงุฒ
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
</div>



<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        ุนููุงุช ุณุฑุน
    </div>
    <div class="card-body">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/accounting" class="btn btn-secondary">ุจุงุฒฺฏุดุช ุจู ุญุณุงุจุฏุงุฑ</a>
            <a href="/accounting/expenses" class="btn btn-warning">ูุฏุฑุช ูุฒููโูุง</a>
            <a href="/accounting/manual-transaction" class="btn btn-primary">ูุฏ ุฏุณุช</a>
            <button onclick="window.print()" class="btn btn-outline-primary">ฺุงูพ</button>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<% if (typeof query !== 'undefined' && query.success) { %>
    <div class="alert alert-success alert-dismissible fade show">
        <% if (query.success === 'account_added') { %>
            โ ุญุณุงุจ ุจุงูฺฉ ุจุง ููููุช ุงุถุงูู ุดุฏ.
        <% } %>
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
<% } %>

<% if (typeof query !== 'undefined' && query.error) { %>
    <div class="alert alert-danger alert-dismissible fade show">
        <% if (query.error === 'add_failed') { %>
            โ ุฎุทุง ุฏุฑ ุงูุฒูุฏู ุญุณุงุจ ุจุงูฺฉ. ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.
        <% } %>
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
<% } %>

<script>
// Bank account management functions
const bankAccountsData = <%- JSON.stringify(bankAccounts) %>;

// Toggle add account form visibility
function toggleAddAccountForm() {
    const card = document.getElementById('addAccountCard');
    const btn = document.getElementById('addAccountBtn');
    
    if (card.style.display === 'none') {
        card.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-times"></i> ุงูุตุฑุงู';
        btn.className = 'btn btn-secondary';
        // Scroll to form
        card.scrollIntoView({ behavior: 'smooth' });
    } else {
        card.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-plus"></i> ุงูุฒูุฏู ุญุณุงุจ ุจุงูฺฉ ุฌุฏุฏ';
        btn.className = 'btn btn-success';
        // Reset form
        document.getElementById('addAccountForm').reset();
    }
}

// Add bank transaction
function addBankTransaction(accountId, bankName) {
    // Redirect to transaction creation page
    window.location.href = `/accounting/manual-transaction?bank_account=${accountId}`;
}

// Edit bank account
function editBankAccount(accountId) {
    const account = bankAccountsData.find(a => a.id === accountId);
    if (!account) return alert('ุญุณุงุจ ูพุฏุง ูุดุฏ');
    
    // Create a proper edit form
    const editData = {
        bank_name: prompt('ูุงู ุจุงูฺฉ:', account.bank_name),
        account_holder: prompt('ุตุงุญุจ ุญุณุงุจ:', account.account_holder),
        branch_name: prompt('ูุงู ุดุนุจู:', account.branch_name || ''),
        account_type: account.account_type
    };
    
    if (editData.bank_name === null || editData.account_holder === null) return;
    
    // Submit edit form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/accounting/bank-accounts/${accountId}/edit`;
    
    Object.keys(editData).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = editData[key] || '';
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// Deactivate account
function deactivateAccount(accountId) {
    if (!confirm('ุขุง ุงุฒ ุบุฑูุนุงูโุณุงุฒ ุงู ุญุณุงุจ ุงุทููุงู ุฏุงุฑุฏุ\nุงู ุนูู ูุงุจู ุจุงุฒฺฏุดุช ุงุณุช.')) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/accounting/bank-accounts/${accountId}/deactivate`;
    document.body.appendChild(form);
    form.submit();
}

// Show edit modal
function showEditModal(accountId) {
    const account = bankAccountsData.find(a => a.id === accountId);
    if (!account) return alert('ุญุณุงุจ ูพุฏุง ูุดุฏ');
    
    // Fill form data
    document.getElementById('edit_bank_name').value = account.bank_name;
    document.getElementById('edit_account_number').value = account.account_number;
    document.getElementById('edit_account_holder').value = account.account_holder;
    document.getElementById('edit_branch_name').value = account.branch_name || '';
    document.getElementById('edit_account_type').value = account.account_type;
    document.getElementById('edit_is_active').value = account.is_active ? '1' : '0';
    document.getElementById('edit_notes').value = account.notes || '';
    
    // Set form action
    document.getElementById('editAccountForm').action = `/accounting/bank-accounts/${accountId}/edit`;
    
    // Show modal
    $('#editAccountModal').modal('show');
}

// View account details
function viewAccountDetails(accountId) {
    const account = bankAccountsData.find(a => a.id === accountId);
    if (!account) return alert('ุญุณุงุจ ูพุฏุง ูุดุฏ');
    
    const balance = parseFloat(account.current_balance || 0);
    const balanceColor = balance >= 0 ? 'success' : 'danger';
    const balanceText = balance >= 0 ? 'ูุซุจุช' : 'ููู';
    
    const detailsHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">ุงุทูุงุนุงุช ุงุตู</h6>
                        <p><strong>ูุงู ุจุงูฺฉ:</strong> ${account.bank_name}</p>
                        <p><strong>ุดูุงุฑู ุญุณุงุจ:</strong> <code>${account.account_number}</code></p>
                        <p><strong>ุตุงุญุจ ุญุณุงุจ:</strong> ${account.account_holder}</p>
                        <p><strong>ูุงู ุดุนุจู:</strong> ${account.branch_name || 'ุชุนุฑู ูุดุฏู'}</p>
                        <p><strong>ููุน ุญุณุงุจ:</strong> 
                            <span class="badge badge-info">${
                                account.account_type === 'checking' ? 'ุฌุงุฑ' :
                                account.account_type === 'savings' ? 'ูพุณโุงูุฏุงุฒ' : 'ุชุฌุงุฑ'
                            }</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">ูุถุนุช ูุงู</h6>
                        <p><strong>ููุฌูุฏ ุฌุงุฑ:</strong> 
                            <span class="text-${balanceColor}">
                                ${Math.abs(balance).toLocaleString('fa-IR')} ุฑุงู (${balanceText})
                            </span>
                        </p>
                        <p><strong>ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง:</strong> ${account.transaction_count || 0}</p>
                        <p><strong>ุชุฑุงฺฉูุดโูุง ุชุทุจู ูุดุฏู:</strong> ${account.unreconciled_count || 0}</p>
                        <p><strong>ูุถุนุช:</strong> 
                            <span class="badge badge-${account.is_active ? 'success' : 'secondary'}">
                                ${account.is_active ? 'ูุนุงู' : 'ุบุฑูุนุงู'}
                            </span>
                        </p>
                        <p><strong>ุชุงุฑุฎ ุงุฌุงุฏ:</strong> ${new Date(account.created_at).toLocaleDateString('fa-IR')}</p>
                    </div>
                </div>
            </div>
        </div>
        ${account.notes ? `
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">ุงุฏุฏุงุดุชโูุง</h6>
                    <p>${account.notes}</p>
                </div>
            </div>
        ` : ''}
    `;
    
    document.getElementById('accountDetailsContent').innerHTML = detailsHTML;
    $('#accountDetailsModal').modal('show');
}

// Auto-hide success/error messages
setTimeout(() => {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        if (alert.classList.contains('fade')) {
            alert.classList.remove('show');
        }
    });
}, 5000);
</script>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="editAccountForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> ูุฑุงุด ุญุณุงุจ ุจุงูฺฉ
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>ูุงู ุจุงูฺฉ: *</label>
                                <input type="text" name="bank_name" id="edit_bank_name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>ุดูุงุฑู ุญุณุงุจ: *</label>
                                <input type="text" name="account_number" id="edit_account_number" class="form-control" required readonly>
                                <small class="text-muted">ุดูุงุฑู ุญุณุงุจ ูุงุจู ุชุบุฑ ูุณุช</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>ุตุงุญุจ ุญุณุงุจ: *</label>
                                <input type="text" name="account_holder" id="edit_account_holder" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>ูุงู ุดุนุจู:</label>
                                <input type="text" name="branch_name" id="edit_branch_name" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>ููุน ุญุณุงุจ: *</label>
                                <select name="account_type" id="edit_account_type" class="form-control" required>
                                    <option value="checking">ุฌุงุฑ</option>
                                    <option value="savings">ูพุณโุงูุฏุงุฒ</option>
                                    <option value="business">ุชุฌุงุฑ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>ูุถุนุช ุญุณุงุจ:</label>
                                <select name="is_active" id="edit_is_active" class="form-control">
                                    <option value="1">ูุนุงู</option>
                                    <option value="0">ุบุฑูุนุงู</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ุงุฏุฏุงุดุช:</label>
                        <textarea name="notes" id="edit_notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ุงูุตุฑุงู</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> ุฐุฎุฑู ุชุบุฑุงุช
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Account Details Modal -->
<div class="modal fade" id="accountDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> ุฌุฒุฆุงุช ุญุณุงุจ ุจุงูฺฉ
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="accountDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ุจุณุชู</button>
            </div>
        </div>
    </div>
</div> 