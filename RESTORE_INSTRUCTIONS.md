# راهنمای بازیابی بک‌آپ - مشکل حل شده

## مشکل قبلی
بازیابی بک‌آپ به دلیل مشکلات Foreign Key constraints و ترتیب نادرست حذف/درج داده‌ها کار نمی‌کرد.

## راه‌حل پیاده‌سازی شده

### 1. ترتیب صحیح حذف جداول
```javascript
const tableClearOrder = [
    'bank_transactions',      // جداول فرزند ابتدا
    'categories', 
    'chart_of_accounts',
    'expenses',
    'expense_categories',
    'financial_transactions',
    'inventory_items',
    'invoices',
    'invoice_items',
    'journal_entries',
    'journal_entry_details',
    'payments',
    'transactions',
    'employees',
    'gold_inventory',
    'gold_rates',
    'other_parties',
    'suppliers',
    'bank_accounts',          // جداول والد در انتها
    'customers',
    'item_types'
];
```

### 2. فرآیند بازیابی امن
1. **غیرفعال کردن Foreign Key Checks**
2. **حذف داده‌های موجود به ترتیب صحیح**
3. **Reset کردن AUTO_INCREMENT**
4. **اجرای دستورات بک‌آپ**
5. **فعال کردن مجدد Foreign Key Checks**

### 3. بهبودهای اضافه شده
- **بک‌آپ امنیتی خودکار** قبل از بازیابی
- **گزارش دقیق** از تعداد عملیات انجام شده
- **مدیریت خطا** برای موارد تکراری
- **تأیید نهایی** وضعیت داده‌ها

## نحوه استفاده

### 1. ایجاد بک‌آپ جدید
```
1. رفتن به /backup
2. انتخاب نوع "کامل"
3. افزودن توضیحات
4. کلیک "ایجاد بک‌آپ امن"
```

### 2. بازیابی بک‌آپ (فقط مدیر)
```
1. کلیک "بازیابی بک‌آپ"
2. انتخاب فایل .sql معتبر
3. تأیید هشدارهای امنیتی
4. کلیک "بازیابی امن"
5. منتظر تکمیل عملیات
```

## ویژگی‌های امنیتی

### 🔒 کنترل دسترسی
- فقط کاربران وارد شده می‌توانند بک‌آپ ایجاد کنند
- فقط مدیران می‌توانند بازیابی انجام دهند

### 🛡️ محافظت از داده‌ها
- بک‌آپ امنیتی خودکار قبل از هر بازیابی
- اعتبارسنجی فایل‌های بازیابی
- جلوگیری از دستورات خطرناک

### 📊 گزارش‌دهی
- ثبت تمام فعالیت‌ها
- نمایش آمار دقیق عملیات
- تأیید وضعیت نهایی داده‌ها

## تست عملکرد

### قبل از بازیابی
```
- مشتریان: X رکورد
- فاکتورها: Y رکورد  
- کالاها: Z رکورد
```

### بعد از بازیابی
```
✅ بازیابی با موفقیت انجام شد!
- 42 دستور اجرا شد
- 15 جدول حذف شد
- 15 جدول ایجاد شد
- 25 عملیات داده انجام شد

وضعیت فعلی:
- مشتریان: A رکورد
- فاکتورها: B رکورد
- کالاها: C رکورد
```

## عیب‌یابی

### اگر بازیابی کامل نشد:
1. بررسی لاگ‌های سرور
2. تأیید فرمت فایل بک‌آپ
3. بررسی دسترسی‌های کاربر
4. استفاده از بک‌آپ امنیتی

### اگر خطای Foreign Key دریافت کردید:
- سیستم جدید خودکار این مشکل را حل می‌کند
- در صورت ادامه مشکل، با پشتیبانی تماس بگیرید

## نکات مهم

⚠️ **همیشه قبل از بازیابی:**
1. بک‌آپ جدید از وضعیت فعلی بگیرید
2. مطمئن شوید فایل بازیابی معتبر است
3. کاربران دیگر از سیستم خارج شده باشند

✅ **بعد از بازیابی:**
1. وضعیت داده‌ها را بررسی کنید
2. عملکرد سیستم را تست کنید
3. در صورت مشکل از بک‌آپ امنیتی استفاده کنید

---
**آخرین بروزرسانی:** 1404/05/02
**نسخه سیستم بک‌آپ:** 2.0 (امن و بهبود یافته)