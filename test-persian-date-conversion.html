<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست تبدیل تاریخ شمسی</title>
    <style>
        body {
            font-family: 'Vazir', Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>تست تبدیل تاریخ شمسی</h1>
        
        <div>
            <h3>تست خودکار</h3>
            <button onclick="runAutomaticTests()">اجرای تست‌های خودکار</button>
            <div id="automaticResults"></div>
        </div>
        
        <div>
            <h3>تست دستی</h3>
            <input type="text" id="persianDateInput" placeholder="1404/05/05" value="1404/05/05">
            <button onclick="testManualConversion()">تبدیل</button>
            <div id="manualResults"></div>
        </div>
        
        <div>
            <h3>تاریخ امروز</h3>
            <button onclick="showTodayDate()">نمایش تاریخ امروز</button>
            <div id="todayResults"></div>
        </div>
    </div>

    <script>
        // Copy the conversion functions from gold-account.js
        class DateConverter {
            convertToPersianDate(date) {
                // Simple but accurate Persian date conversion
                // Using approximation: Persian year = Gregorian year - 621/622
                const gYear = date.getFullYear();
                const gMonth = date.getMonth() + 1;
                const gDay = date.getDate();
                
                // Approximate Persian year (will be adjusted)
                let pYear = gYear - 621;
                
                // Create Persian new year date for this year
                let persianNewYear = new Date(gYear, 2, 21); // March 21st approximation
                
                // Adjust for leap years and exact new year date
                if (date < persianNewYear) {
                    pYear--;
                    persianNewYear = new Date(gYear - 1, 2, 21);
                }
                
                // Calculate days since Persian new year
                const daysSinceNewYear = Math.floor((date - persianNewYear) / (1000 * 60 * 60 * 24)) + 1;
                
                let pMonth, pDay;
                
                if (daysSinceNewYear <= 186) {
                    // First 6 months (31 days each)
                    pMonth = Math.ceil(daysSinceNewYear / 31);
                    pDay = daysSinceNewYear - (pMonth - 1) * 31;
                } else {
                    // Last 6 months
                    const remainingDays = daysSinceNewYear - 186;
                    if (remainingDays <= 150) { // Months 7-11 (30 days each)
                        pMonth = 6 + Math.ceil(remainingDays / 30);
                        pDay = remainingDays - (pMonth - 7) * 30;
                    } else { // Month 12
                        pMonth = 12;
                        pDay = remainingDays - 150;
                    }
                }
                
                // Ensure valid day
                if (pDay <= 0) {
                    pMonth--;
                    if (pMonth <= 0) {
                        pMonth = 12;
                        pYear--;
                    }
                    pDay = (pMonth <= 6) ? 31 : (pMonth < 12 ? 30 : 29);
                }
                
                const year = String(pYear).padStart(4, '0');
                const month = String(pMonth).padStart(2, '0');
                const day = String(pDay).padStart(2, '0');
                
                return `${year}/${month}/${day}`;
            }

            convertPersianToGregorian(persianDateStr) {
                try {
                    const parts = persianDateStr.split('/');
                    if (parts.length !== 3) return null;
                    
                    const pYear = parseInt(parts[0]);
                    const pMonth = parseInt(parts[1]);
                    const pDay = parseInt(parts[2]);
                    
                    // Validate Persian date ranges
                    if (pYear < 1 || pMonth < 1 || pMonth > 12 || pDay < 1 || pDay > 31) {
                        return null;
                    }
                    
                    // Approximate Gregorian year
                    const gYear = pYear + 621;
                    
                    // Persian new year is approximately March 21st
                    const persianNewYear = new Date(gYear, 2, 21); // March 21st
                    
                    // Calculate days to add
                    let daysToAdd = 0;
                    
                    // Add days for complete months
                    for (let m = 1; m < pMonth; m++) {
                        if (m <= 6) {
                            daysToAdd += 31; // First 6 months have 31 days
                        } else {
                            daysToAdd += 30; // Next 5 months have 30 days
                        }
                    }
                    
                    // Add days in current month
                    daysToAdd += pDay - 1;
                    
                    // Create the Gregorian date
                    const gregorianDate = new Date(persianNewYear);
                    gregorianDate.setDate(gregorianDate.getDate() + daysToAdd);
                    
                    return gregorianDate;
                } catch (error) {
                    console.error('Error converting Persian date:', error);
                    return null;
                }
            }



            isValidPersianDate(dateStr) {
                const regex = /^\d{4}\/\d{2}\/\d{2}$/;
                if (!regex.test(dateStr)) return false;
                
                const parts = dateStr.split('/');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                
                // Basic range validation
                if (year < 1300 || year > 1500 || month < 1 || month > 12 || day < 1) {
                    return false;
                }
                
                // Persian calendar specific validation
                if (month <= 6 && day > 31) return false; // First 6 months have 31 days
                if (month > 6 && month <= 11 && day > 30) return false; // Months 7-11 have 30 days
                if (month === 12 && day > 29) {
                    // Month 12 (Esfand) has 29 days in normal years, 30 in leap years
                    const isLeapYear = this.isPersianLeapYear(year);
                    if (!isLeapYear || day > 30) return false;
                }
                
                return true;
            }

            isPersianLeapYear(year) {
                // Persian leap year calculation
                const breaks = [
                    -61, 9, 38, 199, 426, 686, 756, 818, 1111, 1181, 1210,
                    1635, 2060, 2097, 2192, 2262, 2324, 2394, 2456, 3178
                ];
                
                const gy = year + 1595;
                let leap = -14;
                let jp = breaks[0];
                
                let jump = 0;
                for (let j = 1; j <= 19; j++) {
                    const jm = breaks[j];
                    jump = jm - jp;
                    if (year < jm) break;
                    leap += Math.floor(jump / 33) * 8 + Math.floor(((jump % 33) + 3) / 4);
                    jp = jm;
                }
                
                let n = year - jp;
                if (n < jump) {
                    leap += Math.floor(n / 33) * 8 + Math.floor(((n % 33) + 3) / 4);
                    if ((jump % 33) === 4 && (jump - n) === 4) leap++;
                }
                
                return (leap + 4) % 33 < 5;
            }
        }

        const converter = new DateConverter();

        function runAutomaticTests() {
            const results = document.getElementById('automaticResults');
            results.innerHTML = '';
            
            const testCases = [
                { persian: '1404/05/05', description: 'تاریخ امروز (تقریبی)' },
                { persian: '1403/01/01', description: 'اول فروردین 1403' },
                { persian: '1403/12/29', description: 'آخر اسفند 1403' },
                { persian: '1400/06/31', description: 'آخر شهریور 1400' },
                { persian: '1400/07/01', description: 'اول مهر 1400' }
            ];
            
            testCases.forEach(testCase => {
                const div = document.createElement('div');
                div.className = 'test-result';
                
                try {
                    const isValid = converter.isValidPersianDate(testCase.persian);
                    const gregorian = converter.convertPersianToGregorian(testCase.persian);
                    const backToPersian = gregorian ? converter.convertToPersianDate(gregorian) : null;
                    
                    if (isValid && gregorian && backToPersian === testCase.persian) {
                        div.classList.add('success');
                        div.innerHTML = `
                            ✅ ${testCase.description}<br>
                            شمسی: ${testCase.persian}<br>
                            میلادی: ${gregorian.toLocaleDateString('fa-IR')}<br>
                            برگشت به شمسی: ${backToPersian}
                        `;
                    } else {
                        div.classList.add('error');
                        div.innerHTML = `
                            ❌ ${testCase.description}<br>
                            شمسی: ${testCase.persian}<br>
                            معتبر: ${isValid}<br>
                            میلادی: ${gregorian ? gregorian.toLocaleDateString('fa-IR') : 'خطا'}<br>
                            برگشت: ${backToPersian || 'خطا'}
                        `;
                    }
                } catch (error) {
                    div.classList.add('error');
                    div.innerHTML = `❌ خطا در ${testCase.description}: ${error.message}`;
                }
                
                results.appendChild(div);
            });
        }

        function testManualConversion() {
            const input = document.getElementById('persianDateInput').value;
            const results = document.getElementById('manualResults');
            results.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = 'test-result';
            
            try {
                const isValid = converter.isValidPersianDate(input);
                const gregorian = converter.convertPersianToGregorian(input);
                const backToPersian = gregorian ? converter.convertToPersianDate(gregorian) : null;
                
                if (isValid && gregorian) {
                    div.classList.add('success');
                    div.innerHTML = `
                        ✅ تبدیل موفق<br>
                        شمسی: ${input}<br>
                        میلادی: ${gregorian.toLocaleDateString('fa-IR')} (${gregorian.toISOString().split('T')[0]})<br>
                        برگشت به شمسی: ${backToPersian}<br>
                        مطابقت: ${backToPersian === input ? 'بله' : 'خیر'}
                    `;
                } else {
                    div.classList.add('error');
                    div.innerHTML = `
                        ❌ تبدیل ناموفق<br>
                        شمسی: ${input}<br>
                        معتبر: ${isValid}<br>
                        خطا: ${!gregorian ? 'تبدیل به میلادی ناموفق' : 'نامشخص'}
                    `;
                }
            } catch (error) {
                div.classList.add('error');
                div.innerHTML = `❌ خطا: ${error.message}`;
            }
            
            results.appendChild(div);
        }

        function showTodayDate() {
            const results = document.getElementById('todayResults');
            results.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = 'test-result success';
            
            const today = new Date();
            const persianToday = converter.convertToPersianDate(today);
            
            div.innerHTML = `
                📅 تاریخ امروز<br>
                میلادی: ${today.toLocaleDateString('fa-IR')} (${today.toISOString().split('T')[0]})<br>
                شمسی: ${persianToday}<br>
                روز هفته: ${today.toLocaleDateString('fa-IR', { weekday: 'long' })}
            `;
            
            results.appendChild(div);
        }

        // Run automatic tests on page load
        window.onload = function() {
            showTodayDate();
        };
    </script>
</body>
</html>