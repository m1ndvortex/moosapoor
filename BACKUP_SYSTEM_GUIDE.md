# راهنمای سیستم بک‌آپ و بازیابی امن

## نمای کلی

سیستم بک‌آپ و بازیابی امن طراحی شده برای طلافروشی موسی‌پور شامل ویژگی‌های امنیتی پیشرفته و قابلیت‌های کاربردی برای محافظت از اطلاعات مهم کسب‌وکار است.

## ویژگی‌های کلیدی

### 🔒 امنیت
- **احراز هویت**: تمام عملیات نیاز به ورود کاربر دارند
- **کنترل دسترسی**: فقط مدیران مجاز به بازیابی بک‌آپ هستند
- **رمزگذاری نام فایل**: نام فایل‌ها با الگوریتم امن تولید می‌شوند
- **اعتبارسنجی فایل**: بررسی امنیتی محتوای فایل‌های بازیابی
- **محدودیت مسیر**: جلوگیری از حملات Path Traversal
- **بک‌آپ امنیتی**: ایجاد بک‌آپ امنیتی قبل از هر بازیابی

### 📊 انواع بک‌آپ
1. **بک‌آپ کامل** (توصیه شده)
   - شامل ساختار جداول و تمام اطلاعات
   - مناسب برای بازیابی کامل سیستم

2. **بک‌آپ داده‌ها**
   - فقط اطلاعات جداول
   - مناسب برای انتقال داده‌ها

3. **بک‌آپ ساختار**
   - فقط ساختار جداول و روابط
   - مناسب برای راه‌اندازی سیستم جدید

### 🛠️ مدیریت خودکار
- **پاک‌سازی خودکار**: حذف فایل‌های قدیمی بر اساس تنظیمات
- **محدودیت تعداد**: نگهداری حداکثر تعداد مشخصی فایل بک‌آپ
- **بک‌آپ خودکار**: امکان تنظیم بک‌آپ روزانه خودکار

## نحوه استفاده

### 1. دسترسی به سیستم بک‌آپ

#### از طریق منوی اصلی:
```
داشبورد → تنظیمات → بک‌آپ و بازگردانی
```

#### یا مستقیماً:
```
http://localhost:3000/backup
```

### 2. ایجاد بک‌آپ

1. **انتخاب نوع بک‌آپ**:
   - کامل (توصیه شده برای بک‌آپ روزانه)
   - داده‌ها (برای انتقال اطلاعات)
   - ساختار (برای راه‌اندازی جدید)

2. **افزودن توضیحات** (اختیاری):
   - توضیح مختصری از هدف بک‌آپ
   - تاریخ یا رویداد خاص

3. **کلیک روی "ایجاد بک‌آپ امن"**

4. **منتظر تکمیل عملیات باشید**

### 3. دانلود بک‌آپ

1. در جدول تاریخچه بک‌آپ‌ها، روی دکمه "دانلود" کلیک کنید
2. فایل به صورت امن دانلود می‌شود
3. فایل را در مکان امن نگهداری کنید

### 4. بازیابی بک‌آپ (فقط مدیران)

⚠️ **هشدار**: این عملیات تمام اطلاعات فعلی را حذف می‌کند!

1. **کلیک روی "بازیابی بک‌آپ"**
2. **انتخاب فایل بک‌آپ معتبر** (فرمت .sql)
3. **تأیید هشدارهای امنیتی**
4. **کلیک روی "بازیابی امن"**
5. **منتظر تکمیل عملیات باشید**

## تنظیمات پیشرفته (فقط مدیران)

### بک‌آپ خودکار
- **فعال/غیرفعال کردن**: بک‌آپ روزانه در ساعت 23:00
- **نوع بک‌آپ**: معمولاً کامل

### مدیریت فایل‌ها
- **حداکثر تعداد فایل**: 5 تا 50 فایل
- **پاک‌سازی خودکار**: حذف فایل‌های قدیمی‌تر از 30 روز

## ساختار فایل بک‌آپ

```sql
-- Gold Shop Management System - Secure Backup
-- Created: 1404/05/02 - 14:30:25
-- Type: full
-- Description: بک‌آپ روزانه
-- User: مدیر سیستم
-- Database: gold_shop_db

SET FOREIGN_KEY_CHECKS = 0;
SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
SET AUTOCOMMIT = 0;
START TRANSACTION;

-- ========================================
-- TABLE STRUCTURES
-- ========================================

-- Structure for table: customers
DROP TABLE IF EXISTS `customers`;
CREATE TABLE `customers` (
  ...
);

-- ========================================
-- TABLE DATA
-- ========================================

-- Data for table: customers
TRUNCATE TABLE `customers`;
INSERT INTO `customers` (`id`, `customer_code`, ...) VALUES
(1, 'CUS-0001', ...),
...

COMMIT;
SET FOREIGN_KEY_CHECKS = 1;
-- Backup completed at: 1404/05/02 - 14:35:12
```

## امنیت و بهترین شیوه‌ها

### 🔐 امنیت فایل‌ها
- فایل‌های بک‌آپ با دسترسی محدود (600) ذخیره می‌شوند
- نام فایل‌ها شامل شناسه تصادفی امن هستند
- فایل‌های موقت پس از استفاده حذف می‌شوند

### 📋 ثبت فعالیت‌ها
- تمام عملیات بک‌آپ و بازیابی ثبت می‌شوند
- اطلاعات کاربر و زمان عملیات ضبط می‌شود
- خطاها و هشدارها در لاگ سیستم ثبت می‌شوند

### 🛡️ محافظت از داده‌ها
- بک‌آپ امنیتی خودکار قبل از هر بازیابی
- اعتبارسنجی محتوای فایل‌های بازیابی
- جلوگیری از اجرای دستورات خطرناک

## عیب‌یابی

### مشکلات رایج

#### 1. خطای "فایل بک‌آپ یافت نشد"
- **علت**: فایل از سرور حذف شده یا منتقل شده
- **راه‌حل**: بررسی پوشه `backups/` یا ایجاد بک‌آپ جدید

#### 2. خطای "دسترسی غیرمجاز"
- **علت**: کاربر غیرمدیر تلاش به بازیابی
- **راه‌حل**: ورود با حساب مدیر سیستم

#### 3. خطای "فایل نامعتبر"
- **علت**: فایل آسیب دیده یا غیرمعتبر
- **راه‌حل**: استفاده از فایل بک‌آپ معتبر دیگر

#### 4. خطای "حجم فایل زیاد"
- **علت**: فایل بزرگتر از 100MB
- **راه‌حل**: تقسیم بک‌آپ یا افزایش محدودیت

### بررسی سلامت سیستم

```bash
# اجرای تست سیستم بک‌آپ
node test-backup-system.js
```

## API مراجع

### ایجاد بک‌آپ
```javascript
POST /backup/create
Content-Type: application/json

{
  "type": "full|data|schema",
  "description": "توضیحات اختیاری"
}
```

### دانلود بک‌آپ
```javascript
GET /backup/download/:id
```

### بازیابی بک‌آپ
```javascript
POST /backup/restore
Content-Type: multipart/form-data

backupFile: [فایل SQL]
```

### حذف بک‌آپ
```javascript
DELETE /backup/delete/:id
```

## پشتیبانی

برای مشکلات فنی یا سوالات:
1. بررسی لاگ‌های سیستم
2. اجرای تست سیستم بک‌آپ
3. مراجعه به مستندات فنی
4. تماس با پشتیبانی فنی

---

**نکته مهم**: همیشه قبل از انجام تغییرات مهم، بک‌آپ کامل از سیستم تهیه کنید.